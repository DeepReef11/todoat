name: Integration Tests

on:
  push:
    branches: [main]

jobs:
  nextcloud:
    runs-on: ubuntu-latest
    services:
      nextcloud:
        image: nextcloud:latest
        ports:
          - 8080:80
        env:
          NEXTCLOUD_ADMIN_USER: admin
          NEXTCLOUD_ADMIN_PASSWORD: adminpass
          SQLITE_DATABASE: nextcloud
        options: >-
          --health-cmd "curl -f http://localhost/status.php || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 30
          --health-start-period 60s

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.25'
          cache: true

      - name: Wait for Nextcloud to be healthy
        run: |
          echo "Waiting for Nextcloud service to be ready..."
          for i in {1..60}; do
            if curl -sf http://localhost:8080/status.php > /dev/null 2>&1; then
              echo "Nextcloud is ready!"
              break
            fi
            echo "Waiting... ($i/60)"
            sleep 5
          done

      - name: Run Nextcloud integration tests
        env:
          TODOAT_NEXTCLOUD_HOST: http://localhost:8080
          TODOAT_NEXTCLOUD_USERNAME: admin
          TODOAT_NEXTCLOUD_PASSWORD: adminpass
        run: go test -tags=integration -v ./backend/nextcloud/...

  todoist:
    runs-on: ubuntu-latest
    if: ${{ secrets.TODOAT_TODOIST_TOKEN != '' }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: '1.25'
          cache: true

      - name: Run Todoist integration tests
        env:
          TODOAT_TODOIST_TOKEN: ${{ secrets.TODOAT_TODOIST_TOKEN }}
        run: go test -tags=integration -v ./backend/todoist/...
